<!-- menu-item-avatars.html (v1.3) -->

<a id="menu-item-avatars" class="menu-item dialog-holder"><div>Avatars</div></a>

<script>

//  menu-item-avatars.html.

    var $avatarCatalog;
    var bodySectionSelector = "#body-section";
    var dialogSpinnerSelector = ".dialog-spinner";
    var avatarMenuItemSelector = "#menu-item-avatars";

    $(function(){

        var dialogTimeout;
        var target = localPlayer.outfit;
        var component = "dialog-avatar-items.html";

    //  Set dialog panel fetch options.
        $(avatarMenuItemSelector).data("skip", 0);
        $(avatarMenuItemSelector).data("limit", 16);
        $(avatarMenuItemSelector).data("pageIndex", 0);
        $(avatarMenuItemSelector).data("buttonIndex", 0);
        $(avatarMenuItemSelector).data("fetchOptions", { 
            endpoint: "/outfits/find/selectors/options", 
            collection: "outfits", //  zargodb.
            selectors:{
                kind: "outfit",
                type: "dna",
                category: "avatar",
            },
            options:{
                skip: 0,
                limit: 16,
                sort: {_id: -1 },
                fields: {  
                    "kind":1, 
                    "type":1,
                    "outfit":1,
                    "category":1,
                    "gender":1,
                    "title":1,
                    "data":1,
                    "master_snapshot":1,
                },
            },
        });
    
    //  Define dialog panel holder.
        $(avatarMenuItemSelector).on("click", function (){
            clearTimeout(dialogTimeout);
    

        //  Outfit is not avaliable.
            if ( !localPlayer.outfit ) {
                return false;
            }
    
        //  Prevent dialog panel to close only from (x) button.
            if ( this.active ) return false; 
    
            var dialogPanelOpenHandler = () => {

                var spinner = [ 
                    '<div class="dialog-spinner" style="position:absolute;top:0px;width:100%;height:100%;',
                    'background-size:100px; background-position:50% 50%; background-repeat:no-repeat;',
                    'background-image:url(https://i.imgur.com/7qG1W04.gif);"><div>'
                ].join(" ");
    
                $(bodySectionSelector).append(spinner);
    
                return new Promise( (resolve, reject) => {
    
                //  Create dialog panel.
                    resolve( initDialogPanel() );
    
                }).then( ( $dialogPanel ) => {

                    debugMode && console.log("dialog-holder:", this);
    
                //  Define dialog panel holder.
                    $dialogPanel.data("dialog-holder", this);
    
                //  Define dialog panel target.
                    $(this).data("target", localPlayer.outfit);
    
                //  Set dialog panel option.
                    var option = {
                        width: 500,
                        minWidth: 500,
                        maxWidth: 500,
                        height: 650,
                        minHeight: 650,
                        maxHeight: 650,
                        title: "Avatars Catalog Panel",
                    };
    
                //  Load dialog panel contents.
                    var component = "dialog-avatar-items.html";
                    $dialogPanel.loadComponent(component, option);
    
                    $avatarCatalog = $dialogPanel;
                    debugMode && console.log("$avatarCatalog:", $avatarCatalog);
    
                }).catch( (err) => {
                    throw err;
                });
    
            };  
    
        //  end of dialogPanelOpenHandler.
    
            if ( !this.active ){
    
            //  Open dialog panel.
                dialogTimeout = setTimeout( dialogPanelOpenHandler, 500);
    
            } else {
    
            //  Destroy dialog panel.    
                $avatarCatalog.dialog("close");
    
            }

        });
    
    //  Alert target debug error.
        $(avatarMenuItemSelector).on("click", function (){
            if ( !!$avatarCatalog && !$(this).data("target") ){
                bootboxBugAlert("Deny: target not defined.", function(){
                    $avatarCatalog.dialog("close");
                });
            }
        });

    });

</script>
